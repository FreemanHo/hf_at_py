<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>交易策略绩效报告</title>
    <!-- 引入 echarts.js -->
    <script src="echarts.min.js"></script>
</head>

<body>
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div id="table" style="width: 100%;"><br />
        <h3>绩效报告</h3>
        <table style="width: 100%;height:400px;" border="1" , align="center">
            $report_table$
        </table>
    </div>
    <div id="main" align="center" style="width: 100%;height:600px;"></div><br />
    <h3>收益曲线</h3>
    <div id="sub" align="center" style="width: 100%;height:600px;"></div><br />

    <script type="text/javascript">
        // 基于准备好的dom，初始化echarts实例
        var myChart = echarts.init(document.getElementById('main'));

        // 指定图表的配置项和数据
        var upColor = '#ec0000';
        var upBorderColor = '#8A0000';
        var downColor = '#00da3c';
        var downBorderColor = '#008F28';


        // 数据意义：开盘(open)，收盘(close)，最低(lowest)，最高(highest)
        var data0 = splitData($bars$)

        //数据意义：日期，方向（0为买，1为卖），开平（0为开，1为平），价格,手数
        var data1 = $orders$


        function splitData(rawData) {
            var categoryData = [];
            var values = [];
            for (var i = 0; i < rawData.length; i++) {
                categoryData.push(rawData[i].splice(0, 1)[0]);
                values.push(rawData[i]);
            }
            return {
                categoryData: categoryData,
                values: values
            };
        }
        function splitData2(rawData) {
            var categoryData = [];
            var values = [];
            for (var i = 0; i < rawData.length; i++) {
                categoryData.push(rawData[i].splice(0, 1)[0]);
                values.push(rawData[i][0]);
            }
            return {
                categoryData: categoryData,
                values: values
            };
        }



        var pointers = []

        //构造点
        for (var i = 0; i < data1.length; i++) {
            if (data1[i][1] == 0) {
                pointers.push({
                    name: 'XX标点',
                    direction: data1[i][1],
                    offset: data1[i][2],
                    price: data1[i][3],
                    coord: [data1[i][0], data1[i][3]],
                    value: data1[i][4],
                    dtime: data1[i][0],
                    itemStyle: {
                        normal: { color: 'red' }
                    }
                })
            }
            else {
                pointers.push({
                    name: 'XX标点',
                    direction: data1[i][1],
                    offset: data1[i][2],
                    price: data1[i][3],
                    coord: [data1[i][0], data1[i][3]],
                    value: data1[i][4],
                    dtime: data1[i][0],
                    itemStyle: {
                        normal: { color: 'rgb(41,150,85)' }
                    }
                })
            }
        }



        //构造连线
        var marklines = []
        var vol = 0
        var position = []
        var pos = {}
        var closevolume = 0
        for (var i = 0; i < pointers.length; i++) {
            if (pointers[i]['offset'] == 0) {
                position.push({ 'direction': pointers[i]['direction'], 'dtime': pointers[i]['dtime'], 'volume': pointers[i]['value'], 'price': pointers[i]['price'] })
            }
            else {
                closevolume = pointers[i]['value']

                for (var pos of position) {
                    if (pos['direction'] == 0) {
                        if (pos['volume'] == closevolume) {
                            marklines.push(
                                [
                                    {
                                        lineStyle: {
                                            normal: {
                                                color: pos['price'] < pointers[i]['Price'] ? 'red' : 'green',
                                                width: 1,
                                                type: 'dashed'
                                            }
                                        },
                                        itemStyle: {
                                            normal: {
                                                borderWidth: 3,
                                                borderColor: 'yellow',
                                                color: 'red'
                                            }
                                        },
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pos['dtime'], pos['price']],
                                    },
                                    {
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pointers[i]['dtime'], pointers[i]['price']],
                                    }
                                ],
                            )
                            position.shift()
                            break
                        }
                        else if (pos['volume'] > closevolume) {
                            pos['volume'] -= closevolume
                            marklines.push(
                                [
                                    {
                                        lineStyle: {
                                            normal: {
                                                color: pos['price'] > pointers[i]['Price'] ? 'red' : 'green',
                                                width: 1,
                                                type: 'dashed'
                                            }
                                        },
                                        itemStyle: {
                                            normal: {
                                                borderWidth: 3,
                                                borderColor: 'yellow',
                                                color: 'blue'
                                            }
                                        },
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pos['dtime'], pos['price']],

                                    },
                                    {
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pointers[i]['dtime'], pointers[i]['price']],
                                    }
                                ],
                            )
                            break
                        }
                        else {
                            marklines.push(
                                [
                                    {
                                        lineStyle: {
                                            normal: {
                                                color: pos['price'] > pointers[i]['Price'] ? 'red' : 'green',
                                                width: 1,
                                                type: 'dashed'
                                            }
                                        },
                                        itemStyle: {
                                            normal: {
                                                borderWidth: 3,
                                                borderColor: 'yellow',
                                                color: 'blue'
                                            }
                                        },
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pos['dtime'], pos['price']],

                                    },
                                    {
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pointers[i]['dtime'], pointers[i]['price']],
                                    }
                                ],
                            )
                            position.shift()
                        }
                    }
                    else {
                        if (pos['volume'] == closevolume) {
                            marklines.push(
                                [
                                    {
                                        lineStyle: {
                                            normal: {
                                                color: pos['price'] > pointers[i]['Price'] ? 'red' : 'green',
                                                width: 1,
                                                type: 'dashed'
                                            }
                                        },
                                        itemStyle: {
                                            normal: {
                                                borderWidth: 3,
                                                borderColor: 'yellow',
                                                color: 'blue'
                                            }
                                        },
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pos['dtime'], pos['price']],

                                    },
                                    {
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pointers[i]['dtime'], pointers[i]['price']],
                                    }
                                ],
                            )
                            position.shift()
                            break
                        }
                        else if (pos['volume'] > closevolume) {
                            pos['volume'] -= closevolume
                            marklines.push(
                                [
                                    {
                                        lineStyle: {
                                            normal: {
                                                color: pos['price'] > pointers[i]['Price'] ? 'red' : 'green',
                                                width: 1,
                                                type: 'dashed'
                                            }
                                        },
                                        itemStyle: {
                                            normal: {
                                                borderWidth: 3,
                                                borderColor: 'yellow',
                                                color: 'blue'
                                            }
                                        },
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pos['dtime'], pos['price']],

                                    },
                                    {
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pointers[i]['dtime'], pointers[i]['price']],
                                    }
                                ],
                            )
                            break
                        }
                        else {
                            marklines.push(
                                [
                                    {
                                        lineStyle: {
                                            normal: {
                                                color: pos['price'] > pointers[i]['Price'] ? 'red' : 'green',
                                                width: 1,
                                                type: 'dashed'
                                            }
                                        },
                                        itemStyle: {
                                            normal: {
                                                borderWidth: 3,
                                                borderColor: 'yellow',
                                                color: 'blue'
                                            }
                                        },
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pos['dtime'], pos['price']],

                                    },
                                    {
                                        symbol: 'triangle',
                                        symbolSize: 8,
                                        coord: [pointers[i]['dtime'], pointers[i]['price']],


                                    }
                                ],
                            )
                            position.shift()
                        }
                    }
                }
            }
        }

        option =
            {
                title: {
                    text: '信号图',
                    left: 0
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                //legend: {
                //    data: ['日K']
                //},
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: data0.categoryData,
                    scale: true,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    splitLine: { show: false },
                    splitNumber: 20,
                    min: 'dataMin',
                    max: 'dataMax'
                },
                yAxis: {
                    scale: true,
                    splitArea: {
                        show: true
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 50,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        y: '90%',
                        start: 50,
                        end: 100
                    }
                ],
                series:
                    [
                        {
                            name: '日K',
                            type: 'candlestick',
                            data: data0.values,
                            itemStyle: {
                                normal: {
                                    color: upColor,
                                    color0: downColor,
                                    borderColor: upBorderColor,
                                    borderColor0: downBorderColor
                                }
                            },
                            markPoint: {
                                label: {
                                    normal: {
                                        formatter: function (param) {
                                            return param != null ? Math.round(param.value) : '';
                                        }
                                    }
                                },
                                data: pointers,
                                tooltip: {
                                    formatter: function (param) {
                                        return param.name + '<br>' + (param.data.coord || '');
                                    }
                                }
                            },
                            markLine: {
                                symbol: ['circle', 'circle'],

                                symbolSize: 10,
                                data: marklines,
                            }
                        },
                        /*
                        {
                            {
                                name: 'MA5',
                                type: 'line',
                                data: indexs,
                                smooth: true,
                                lineStyle: {
                                normal: {opacity: 0.5}
                                }
                            }
                        }*/
                    ]
            };

        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);

        var dayEquity = splitData2($quanyi$)
        var myChart2 = echarts.init(document.getElementById('sub'));

        option2 = {
            xAxis: {
                type: 'category',
                data: dayEquity.categoryData
            },
            yAxis: {
                type: 'value',
                max: function (value) {
                    return value.max + 20
                },
                min: function (value) {
                    return value.min - 20
                }

            },
            series: [{
                data: dayEquity.values,
                type: 'line',
                smooth: true
            }]
        };

        myChart2.setOption(option2);
    </script>
</body>

</html>